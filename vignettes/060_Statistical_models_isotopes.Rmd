---
title: "#6: Statistical models"
author: 
- Nadege Belouard^[EcoBio, nadege.belouard@gmail.com]
date: "23/09/2022"
output:
  pdf_document:
    toc: TRUE
    toc_depth: 2
  html_document:
    toc: TRUE
    toc_depth: 3
params:
  show_code: FALSE
  export_figures: TRUE
editor_options: 
  chunk_output_type: console
---

This vignette tests the link between the isotopic niche metrics of amphibians and candidate variables, including crayfish.


# 1. Setup

We begin by loading the required libraries and datasets.

```{r setup, include = FALSE}

#Load packages
library(lme4)
library(car)
library(MuMIn)
library(ggplot2)
library(RVAideMemoire)
library(ggrepel)
library(magrittr)
library(Hmisc)
library(usdm)
library(tidyr)
library(dplyr)
library(tibble)
library(gridExtra)
library(here)

```

```{r load datasets}
#Load datasets
Envt <- read.csv(file.path(here(), "data_raw", "Raw_environment.csv"), h = T)

# Dataset
Niche_metrics <- read.csv(file.path(here(), "exported_data", 
                                    "Population_metrics.csv"), h = T) %>% 
  dplyr::select(Code, Pond, Species, NRcp, CRcp, TAcp, CDcp, MNNDcp, SDNNDcp, SEAc)

Mean_position <- read.csv(file.path(here(), "exported_data", 
                                    "Meanposition_SEAc.csv"), header = T)
names(Mean_position)[3] <- "Code"


CD_global <- read.csv(file.path(here(), "exported_data", "CD_global.csv"), h = T)
CD_global %<>% dplyr::select(Code, Species, CDcp)
CD_global %<>% rename(Pond = Code,
                      CDg = CDcp)

```

```{r merge datasets}

Pop_metrics <- merge(Niche_metrics, Mean_position, 
                     by = c("Pond", "Code", "Species"))
dim(Pop_metrics)[1] == dim(Niche_metrics)[1]
dim(Pop_metrics)[1] == dim(Mean_position)[1]

for (i in 1:length(Pop_metrics$Pond)) {
  if (Pop_metrics$Species[i] %in% c("Agile frog", "Tree frog")) {
    Pop_metrics$Group[i] = "Tadpoles"
    Pop_metrics$Clade[i] = "Amphibians"
  } else if (Pop_metrics$Species[i] %in% c("Palmate newt", "Marbled newt")) {
    Pop_metrics$Group[i] = "Newts"
    Pop_metrics$Clade[i] = "Amphibians"
  } else {
    Pop_metrics$Group[i] = "Crayfish"
    Pop_metrics$Clade[i] = "Crayfish"
  }
}

#Add the variable Tadpoles
Candidate <- Envt %>% mutate(Tadpoles = Agile_frog+Tree_frog)

#Create a dataset only for amphibian populations
Pop_amphib <- Pop_metrics %>% filter(Clade == "Amphibians")

#Merge metrics and explicative variables
Pop_dataset <- merge(Pop_amphib, Candidate, by = "Pond")
print("Is there still 44 populations in the dataset?")
dim(Pop_dataset)[1] == 44

```


# Metrics correlation

First, we test the correlation between metrics, in order to determine whether some of them are irrelevant to test.

```{r compare metrics}

Metrics <- merge(CD_global,
                     Pop_amphib) %>% 
  dplyr::select(-Pond, -Species, -Code, -Group, -Clade) 

# Compute the correlations between niche netrics
Metrics_cor <- rcorr(as.matrix(Metrics), type = "spearman")
# All metrics are extremely correlated except with NR (max = 0.50)

```

The six metrics of Layman are all highly correlated, except CR and NR (r = 0.08, p > 0.5). It means that there is a close relationship between niche core size, niche total size, and distance between individuals, but a lower correlation between the number of trophic levels encompassed and the breadth of resources used.


# 2. Models: variation in amphibian niche metrics

For each metric tested, we (1) check GOF of a simple model, and transform the metric if necessary, (2) run the model selection and (3) plot the figure corresponding to the selected models.


### CR

```{r check GOF for CR}
# mod1 <- lmer(CRcp ~ scale(Canopycover) + (1|Pond), na.action="na.fail", data=Pop_dataset)
mod1 <- lmer(CRcp ~ scale(Canopycover) + (1|Species) + (1|Pond), 
             na.action="na.fail", data=Pop_dataset)
plotresid(mod1)

mod1 <- lmer(CRcp ~ scale(Canopycover) + (1|Species) + (1|Pond), 
             na.action="na.fail", data=Pop_dataset)
plotresid(mod1)
```
Residuals do not look ok, there are 2 or 3 outliers. We try to log-transform CR to obtain normal residuals.


```{r check GOF for log-transformed CR}
#Transform metric to obtain normal residuals
mod2 <- lmer(log(CRcp) ~ scale(Canopycover) + (1|Species) + (1|Pond), 
             na.action="na.fail", data=Pop_dataset)
plotresid(mod2)

mod2 <- lmer(log(CRcp) ~ scale(Canopycover) + (1|Species) + (1|Pond), 
             na.action="na.fail", data=Pop_dataset)
plotresid(mod2)
```

Residuals are better after CR is log-transformed, even though they are still not completely normal. We proceed with the transformed CR and will have a look at residuals of selected models.

```{r dredge CR model}
#Test variables
mod_CR <- lmer(log(CRcp) ~ 
                 scale(Area) + scale(Canopycover) + scale(Aq_VegCover) +
                 scale(CrayfishCPUE) +
                 scale(Agile_frog) + scale(Tree_frog) + scale(Palmate_newt) + 
                 scale(Marbled_newtCPUE) + 
                 (1|Species), na.action="na.fail", data=Pop_dataset)

# summary(mod_CR)
CR_dredge <- dredge(mod_CR, rank=AICc, m.lim=c(0,2), extra="R^2")
CR_select <- subset(CR_dredge, delta < 2)
CR_select

```

Two models are retained in deltaAIC < 2. 

```{r check the content of each model for CR}
# Check the content of each model selected
CR_list <- dredge(mod_CR, rank=AICc, m.lim=c(0,2), extra="R^2", evaluate=FALSE)
length(CR_list)

CR_list$'34' #agile frog, marbled newt
Model_selected2 <- lmer(log(CRcp) ~ scale(Agile_frog) + scale(Marbled_newtCPUE) + 
                          (1|Pond) + (1|Species),
             na.action="na.fail", data=Pop_dataset)
plotresid(Model_selected2)
res <- summary(Model_selected2)
round(res$coefficients,2)
Anova(Model_selected2)

CR_list$'10' # agile frog, canopy cover
Model_selected1 <- lmer(log(CRcp) ~ scale(Agile_frog) + scale(Canopycover) + 
                          (1|Species),
             na.action="na.fail", data=Pop_dataset)
plotresid(Model_selected1)
res <- summary(Model_selected1)
round(res$coefficients,2)
Anova(Model_selected1)
```

## Figure 3: significant variables for CR
```{r corresponding figures for CR}


Pop_dataset$Species <- factor(Pop_dataset$Species, levels = c("Crayfish",
                                                    "Agile frog",
                                                    "Tree frog",
                                                    "Palmate newt",
                                                    "Marbled newt"))


CR_agile <- ggplot(Pop_dataset, aes(y = log(CRcp), x = scale(Agile_frog), 
                                    group = Species)) +
  geom_smooth(method="lm",se=F, aes(col = Species)) +
  geom_point(aes(col = Species), size = 2) +
  xlab("Agile frog density, scaled") +
  ylab("log(CRcp)") +
  scale_color_manual(values = c("#0072B2", "#009E73", 
                                "#56B4E9", "#CC79A7")) +
  theme_classic() +
  theme(legend.position="none")
CR_agile


CR_marbre <- ggplot(Pop_dataset, aes(y = log(CRcp), x = scale(Marbled_newtCPUE), 
                                     group = Species)) +
  geom_smooth(method="lm",se=F, aes(col = Species)) +
  geom_point(aes(col = Species), size = 2) +
  scale_color_manual(values = c("#0072B2", "#009E73", 
                                "#56B4E9", "#CC79A7")) +
  xlab("Marbled newt abundance, scaled") +
  ylab("log(CRcp)") +
  theme_classic() +
  theme(legend.position="none")
CR_marbre

CR_canopy <- ggplot(Pop_dataset, aes(y = log(CRcp), x = scale(Canopycover), 
                                     group = Species)) +
  geom_smooth(method="lm",se=F, aes(col = Species)) +
  geom_point(aes(col = Species), size = 2) +
  scale_color_manual(values = c("#0072B2", "#009E73", 
                                "#56B4E9", "#CC79A7")) +
  xlab("Canopy cover, scaled") +
  ylab("log(CRcp)") +
  theme_classic() +
  theme(legend.position="none")
CR_canopy


CR_crayfish <- ggplot(Pop_dataset, aes(y = log(CRcp), x = scale(CrayfishCPUE), 
                                       group = Species)) +
  geom_point(aes(col = Species), size = 2) +
  scale_color_manual(values = c("#0072B2", "#009E73", 
                                "#56B4E9", "#CC79A7")) +
  xlab("Crayfish abundance, scaled") +
  ylab("log(CRcp)") +
  theme_classic() +
  theme(legend.position="none")
CR_crayfish

g <- grid.arrange(CR_agile, CR_marbre, CR_canopy, CR_crayfish, ncol = 2)
g
ggsave(file.path(here(), "figures", "CRcp.jpg"), g, width = 6, height = 6)

``` 



### NR

Next, we analyze NR.

```{r check GOF for NR}

#Check residuals
mod1<-lmer(NRcp ~ scale(Canopycover) + (1|Species), na.action="na.fail", 
           data=Pop_dataset)
plotresid(mod1)
```

The model has singularities. Residuals appear correct but can be improved.

```{r check GOF for log-transformed NR}
#Transform metric
mod2<-lmer(log(NRcp) ~ scale(Canopycover) + (1|Species), na.action="na.fail", 
           data=Pop_dataset)
plotresid(mod2)
```
Residuals are not really improved by the transformation. We can transform the metric or keep it untransformed.


```{r dredge NR model}

mod_NR<-lmer(log(NRcp) ~ scale(Area) + scale(Canopycover) + scale(Aq_VegCover) +
               scale(CrayfishCPUE) +
               scale(Agile_frog) + scale(Tree_frog) + scale(Palmate_newt) + 
               scale(Marbled_newtCPUE) +
               scale(Tadpoles) + (1|Species), na.action="na.fail", 
             data=Pop_dataset)
NR_dredge <- dredge(mod_NR, rank=AICc, m.lim=c(0,2), extra="R^2")
NR_select <- subset(NR_dredge, delta<2)
NR_select

```

Only the null is retained within deltaAIC < 2.
