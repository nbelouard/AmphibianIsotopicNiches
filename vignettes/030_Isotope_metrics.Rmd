---
title: "#3: Compute niche metrics"
author: 
- Nadege Belouard^[UMR CNRS EcoBio, UMR DECOD, nadege.belouard@gmail.com]
date: "23/03/2023"
output:
  pdf_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

This vignette computes all the population stable isotope niche metrics.
We first load the packages.

```{r setup, warning = F, message = F}
library(SIBER)
library(dplyr)
library(ggplot2)
library(here)
library(magrittr)
library(tidyr)
library(tibble)
library(knitr)
library(siar)
library(reshape2)
library(spatstat.utils)
```

We then load the dataset and keep only the variables that will be useful. 
```{r load dataset}

Dataset <- read.csv(file.path(here(), "exported_data", 
                                       "Isotope_data_standardized.csv"), 
                    header=T)

Dataset %<>% dplyr::select(Pond, Taxa, Species, Group, Sample_ID, 
                    Weight, TP, D13Ccor_consoI)
  
head(Dataset)
```


# 1- Regional niche (per species over all ponds)

Select the appropriate species and get the average position of their regional niche. Then split the dataset per species for calculations.
```{r select appropriate species}
spx <- split(Dataset$D13Ccor_consoI, Dataset$Species, drop = TRUE)
spy <- split(Dataset$TP, Dataset$Species, drop = TRUE)

```


## a- SEA coordinates

Generate the coordinates of the standard ellipses for each regional niche and export them.
```{r regional SEAc coordinates}

Species <- NULL
coordY <- NULL
coordX <- NULL
j = 1

for (i in 1:length(spx)) {
  SE <- siar::standard.ellipse(spx[[i]], spy[[i]], steps = 1)
  Species[j:(j+360)] <- names(spx)[i]
  coordY[j:(j+360)] <- SE$ySEAc[1:361]
  coordX[j:(j+360)] <- SE$xSEAc[1:361]
  j = j + 361
}

CoordSEAc <- cbind(Species, coordY, coordX)
CoordSEAc <- as.data.frame(CoordSEAc)
CoordSEAc$coordY <- as.numeric(as.character(CoordSEAc$coordY))
CoordSEAc$coordX <- as.numeric(as.character(CoordSEAc$coordX))

write.csv(CoordSEAc, file.path(here(), "exported_data", 
                               "Coordinates_SEAc_regional.csv"), row.names = F)
``` 


## b- Ellipse areas and overlap at the regional scale

Calculate the ellipse areas and the overlap with other species at the regional scale
```{r area of ellipses overlap}

#Initialize vectors
Species1 = NULL
Species2 = NULL
AreaOverlap = NULL
AreaSp1 = NULL
AreaSp2 = NULL
Table = data.frame()

# Run command: with crayfish
for (i in names(spx[c(1,3:5)])){
Overlap <- siar::overlap(spx$Crayfish, spy$Crayfish,
                         spx[[i]], spy[[i]], steps=1)
AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
Species1 <- append(Species1, "Crayfish", after = length(Species1))
Species2 <- append(Species2, names(spx[i]), after = length(Species2))
AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
} 
 
# Run command: with agile frog
for (i in names(spx[c(3:5)])){
Overlap <- siar::overlap(spx$`Agile frog`, spy$`Agile frog`,
                         spx[[i]], spy[[i]], steps=1)
AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
Species1 <- append(Species1, "Agile frog", after = length(Species1))
Species2 <- append(Species2, names(spx[i]), after = length(Species2))
AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
} 

# Run command: with marbled newt
for (i in names(spx[c(4:5)])){
Overlap <- siar::overlap(spx$`Marbled newt`, spy$`Marbled newt`,
                         spx[[i]], spy[[i]], steps=1)
AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
Species1 <- append(Species1, "Marbled newt", after = length(Species1))
Species2 <- append(Species2, names(spx[i]), after = length(Species2))
AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
}


# Run command: palmate newt/tree frog (the only one left)
Overlap <- siar::overlap(spx$`Palmate newt`, spy$`Palmate newt`,
                         spx$`Tree frog`, spy$`Tree frog`, steps=1)
AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
Species1 <- append(Species1, "Palmate newt", after = length(Species1))
Species2 <- append(Species2, "Tree frog", after = length(Species2))
AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))

```


Merge all values in a single table and export it
``` {r analyses of regional overlaps}

Table <- cbind(Species1, Species2, AreaOverlap = round(AreaOverlap,4), 
             AreaSp1 = round(AreaSp1,4), AreaSp2 = round(AreaSp2,4))

Table <- as.data.frame(Table)
Table$Prct_overlap <- round(as.numeric(Table$AreaOverlap) / (as.numeric(Table$AreaSp1)+as.numeric(Table$AreaSp2)),4)
Table$Prct_overlap_sp2 <- round(as.numeric(Table$AreaOverlap) / as.numeric(Table$AreaSp2),4)
Table$Prct_overlap_sp1 <- round(as.numeric(Table$AreaOverlap) / as.numeric(Table$AreaSp1),4)

kable(Table)

write.csv(Table, file.path(here(), "exported_data", 
                           "Overlap_regional_niches.csv"), row.names = F)
```




# 2- Population metrics

We calculate population metrics for amphibians and crayfish.

We begin with selecting the species of interest and removing populations with inadequate samples sizes, i.e. large populations with n < 10. Some populations have n < 10 but are kept because we have good indicators from CMR that the sample size is representative of the population.

```{r select appropriate populations, message = F, warning = F}

# We want to exclude target populations with n < 10, except three pops: marbled newt in ponds P04 and P11, and palmate newt in pop P10 where we assume we have sampled the entire population.
Dataset %>% group_by(Species, Pond) %>% summarise(n = n()) %>% 
  filter(n < 10)

Dataset<-Dataset[!Dataset$Species=="Crayfish"|
                                 !Dataset$Pond == "P06",]
Dataset<-Dataset[!Dataset$Species=="Agile frog"|
                                 !Dataset$Pond=="P02",]
Dataset<-Dataset[!Dataset$Species=="Agile frog"|
                                 !Dataset$Pond=="P17",]
Dataset<-Dataset[!Dataset$Species=="Marbled newt"|
                                 !Dataset$Pond=="P08",]
Dataset<-Dataset[!Dataset$Species=="Marbled newt"|
                                 !Dataset$Pond=="P10",]
Dataset<-Dataset[!Dataset$Species=="Palmate newt"|
                                 !Dataset$Pond=="P07",]
Dataset<-Dataset[!Dataset$Species=="Palmate newt"|
                                 !Dataset$Pond== "P13",]
Dataset<-Dataset[!Dataset$Species=="Palmate newt"|
                                 !Dataset$Pond== "P14",]
Dataset<-Dataset[!Dataset$Species=="Palmate newt"|
                                 !Dataset$Pond=="P16",]
Dataset<-Dataset[!Dataset$Species=="Palmate newt"|
                                 !Dataset$Pond=="P17",]


table(Dataset$Pond, Dataset$Species)

# Separate per niche (species x pond)
spx <- split(Dataset$D13Ccor_consoI, 
             list(Dataset$Pond, Dataset$Species), drop = TRUE)
spy <- split(Dataset$TP, 
             list(Dataset$Pond, Dataset$Species), drop = TRUE)

```

Check if the number of individuals is correct
```{r check number of individuals is correct}

dim(Dataset[Dataset$Taxa=="Agile frog",])[1] == 254 
dim(Dataset[Dataset$Taxa=="Tree frog",])[1] == 168
dim(Dataset[Dataset$Taxa=="Palmate newt",])[1] == 192
dim(Dataset[Dataset$Taxa=="Marbled newt",])[1] == 101
dim(Dataset[Dataset$Species=="Crayfish",])[1] == 348

```


## a- SEA coordinates 

We then generate the coordinates of the ellipses so we can plot them later.

```{r population SEAc coordinates, warning = F, message = F}

Pop <- NULL
coordY <- NULL
coordX <- NULL
j = 1

for (i in 1:length(spx)) {
  SE <- standard.ellipse(spx[[i]],spy[[i]],steps=1)
  Pop[j:(j+360)]<-names(spx)[i]
  coordY[j:(j+360)]<-SE$ySEAc[1:361]
  coordX[j:(j+360)]<-SE$xSEAc[1:361]
  j=j+361
}

CoordSEAc <- cbind(Pop,coordY,coordX)
summary(CoordSEAc)
CoordSEAc <- as.data.frame(CoordSEAc)
CoordSEAc$coordY <- as.numeric(as.character(CoordSEAc$coordY))
CoordSEAc$coordX <- as.numeric(as.character(CoordSEAc$coordX))
str(CoordSEAc)
CoordSEAc$Pond <- gsub("\\..*","",CoordSEAc$Pop)
CoordSEAc$Species <- gsub(".*\\.","",CoordSEAc$Pop)
head(CoordSEAc)
CoordSEAc$Pond <- as.factor(CoordSEAc$Pond)
levels(CoordSEAc$Pond)

write.csv(CoordSEAc, 
          file.path(here(), "exported_data", "Coordinates_SEAc_populations.csv"), 
          row.names = F)
``` 


Calculate the mean position of standard ellipses (centroids) at the pond level
```{r centroides of standard ellipses}

Mean_position <- CoordSEAc %>% group_by(Pond, Species, Pop) %>%
  summarise(TPavg = mean(coordY),
            D13Cavg = mean(coordX))

write.csv(Mean_position, file.path(here(), "exported_data", 
                                   "Meanposition_SEAc.csv"), row.names = F)

```




## b- Ellipse areas and overlap at the pond scale

Calculate the area and percentage of ellipse overlap at the population level

```{r area of ellipses overlap: initialize vectors}

#Split dataset by species
Crayfish <- Dataset %>% filter(Species == "Crayfish")
Treefrog <- Dataset %>% filter(Species == "Tree frog")
Agilefrog <- Dataset %>% filter(Species == "Agile frog") 
Palmatenewt <- Dataset %>% filter(Species == "Palmate newt")
Marblednewt <- Dataset %>% filter(Species == "Marbled newt") 


#For each species, split dataset by pond
spx_Agilefrog <- split(Agilefrog$D13Ccor_consoI, list(Agilefrog$Pond), 
                       drop = FALSE)
spy_Agilefrog <- split(Agilefrog$TP, list(Agilefrog$Pond), 
                       drop = FALSE)
spx_Treefrog <- split(Treefrog$D13Ccor_consoI, list(Treefrog$Pond), 
                       drop = FALSE)
spy_Treefrog <- split(Treefrog$TP, list(Treefrog$Pond), 
                       drop = FALSE)
spx_Palmatenewt <- split(Palmatenewt$D13Ccor_consoI, list(Palmatenewt$Pond), 
                       drop = FALSE)
spy_Palmatenewt <- split(Palmatenewt$TP, list(Palmatenewt$Pond), 
                       drop = FALSE)
spx_Marblednewt <- split(Marblednewt$D13Ccor_consoI, list(Marblednewt$Pond), 
                       drop = FALSE)
spy_Marblednewt <- split(Marblednewt$TP, list(Marblednewt$Pond), 
                       drop = FALSE)
spx_Crayfish <- split(Crayfish$D13Ccor_consoI, list(Crayfish$Pond), 
                       drop = FALSE)
spy_Crayfish <- split(Crayfish$TP, list(Crayfish$Pond), 
                       drop = FALSE)

#Initialize vectors
Pond = NULL
Species1 = NULL
Species2 = NULL
AreaOverlap = NULL
AreaSp1 = NULL
AreaSp2 = NULL
Table = data.frame()
```

## All crayfish
```{r loop over all crayfish}

for (i in names(spx_Crayfish)) {
  if (length(spx_Agilefrog[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Crayfish", after = length(Species1))
    Species2 <- append(Species2, "Agile frog", after = length(Species2))
    Overlap <- siar::overlap(spx_Crayfish[[i]], spy_Crayfish[[i]],
                             spx_Agilefrog[[i]], spy_Agilefrog[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Treefrog[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Crayfish", after = length(Species1))
    Species2 <- append(Species2, "Tree frog", after = length(Species2))
    Overlap <- siar::overlap(spx_Crayfish[[i]], spy_Crayfish[[i]],
                             spx_Treefrog[[i]], spy_Treefrog[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Palmatenewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Crayfish", after = length(Species1))
    Species2 <- append(Species2, "Palmate newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Crayfish[[i]], spy_Crayfish[[i]],
                             spx_Palmatenewt[[i]], spy_Palmatenewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Marblednewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Crayfish", after = length(Species1))
    Species2 <- append(Species2, "Marbled newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Crayfish[[i]], spy_Crayfish[[i]],
                             spx_Marblednewt[[i]], spy_Marblednewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}
```

## Between amphibians
```{r area of ellipses overlap: loop between amphibians}

for (i in names(spx_Agilefrog)) {
  if (length(spx_Treefrog[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Agile frog", after = length(Species1))
    Species2 <- append(Species2, "Tree frog", after = length(Species2))
    Overlap <- siar::overlap(spx_Agilefrog[[i]], spy_Agilefrog[[i]],
                             spx_Treefrog[[i]], spy_Treefrog[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Palmatenewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Agile frog", after = length(Species1))
    Species2 <- append(Species2, "Palmate newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Agilefrog[[i]], spy_Agilefrog[[i]],
                             spx_Palmatenewt[[i]], spy_Palmatenewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Marblednewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Agile frog", after = length(Species1))
    Species2 <- append(Species2, "Marbled newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Agilefrog[[i]], spy_Agilefrog[[i]],
                             spx_Marblednewt[[i]], spy_Marblednewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}



for (i in names(spx_Treefrog)) {
  if (length(spx_Palmatenewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Tree frog", after = length(Species1))
    Species2 <- append(Species2, "Palmate newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Treefrog[[i]], spy_Treefrog[[i]],
                             spx_Palmatenewt[[i]], spy_Palmatenewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Marblednewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Tree frog", after = length(Species1))
    Species2 <- append(Species2, "Marbled newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Treefrog[[i]], spy_Treefrog[[i]],
                             spx_Marblednewt[[i]], spy_Marblednewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}


for (i in names(spx_Palmatenewt)) {
  if (length(spx_Marblednewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Palmate newt", after = length(Species1))
    Species2 <- append(Species2, "Marbled newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Palmatenewt[[i]], spy_Palmatenewt[[i]],
                             spx_Marblednewt[[i]], spy_Marblednewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}

```


Merge them in a table and export it

``` {r analyses of population overlaps}

Table <- cbind(Pond, Species1, Species2, AreaOverlap = round(AreaOverlap,4), 
             AreaSp1 = round(AreaSp1,4), AreaSp2 = round(AreaSp2,4))

Table <- as.data.frame(Table)
Table$Prct_overlap <- round(as.numeric(Table$AreaOverlap) / (as.numeric(Table$AreaSp1)+as.numeric(Table$AreaSp2)),4)
Table$Prct_overlap_sp2 <- round(as.numeric(Table$AreaOverlap) / as.numeric(Table$AreaSp2),4)
Table$Prct_overlap_sp1 <- round(as.numeric(Table$AreaOverlap) / as.numeric(Table$AreaSp1),4)

head(Table)

write.csv(Table, file.path(here(), "exported_data", "Overlap_populations.csv"), 
          row.names = F)

```

Finally generate a table with all SEAc at the pond scale

```{r calculate population ellipses}

Dataset_ellipses <- Dataset %>% 
  dplyr::select("iso1" = D13Ccor_consoI, "iso2" = TP, "group" = Species, 
                "community" = Pond) %>%
  as.data.frame()

Dataset_SIBER <- createSiberObject(Dataset_ellipses)
Pop_metrics_SEAc <- groupMetricsML(Dataset_SIBER)

#Table transformation
Pop_metrics_ellipses <- as.data.frame(t(Pop_metrics_SEAc))
Pop_metrics_ellipses$Code <- rownames(Pop_metrics_ellipses)
Pop_metrics_ellipses$Pond <- gsub("[.].*","",Pop_metrics_ellipses$Code)
Pop_metrics_ellipses$Species <- gsub(".*.[.]","",Pop_metrics_ellipses$Code)

write.csv(Pop_metrics_ellipses[-1], 
          file.path(here(), "exported_data", "Population_metrics.csv"), 
          row.names = F)
```


# Long table
Generate the long version of this table combining SEAc and mean position for Supplementary Material

```{r generate the long version of this table for Supp Mat}

Pop_metrics <- read.csv(file.path(here(), "exported_data", 
                                  "Population_metrics.csv"))

Mean_position <- read.csv(file.path(here(), "exported_data", 
                                    "Meanposition_SEAc.csv"))

names(Mean_position)[3] = "Code"
Mean_position %<>% dplyr::select(-Pond, -Species) 
Pop_metrics <- merge(Pop_metrics, Mean_position, by = "Code")
Pop_metrics %<>% dplyr::select(Pond, Species, SEAc, TPavg, D13Cavg)

Pop_metrics_long <- rbind(
      Pop_metrics %>% dcast(Pond ~ Species, value.var = "SEAc") %>% add_column(Metrics = "SEAc"),
      Pop_metrics %>% dcast(Pond ~ Species, value.var = "TPavg") %>% add_column(Metrics = "TPavg"),
      Pop_metrics %>% dcast(Pond ~ Species, value.var = "D13Cavg") %>% add_column(Metrics = "D13Cavg"))
      

write.csv(Pop_metrics_long, file.path(here(), "exported_data", "Population_metrics_long.csv"), row.names = F)
```

