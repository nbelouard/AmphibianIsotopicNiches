---
title: "#3: Compute niche metrics"
author: 
- Nadege Belouard^[UMR CNRS EcoBio, UMR DECOD, nadege.belouard@gmail.com]
date: "23/03/2023"
output:
  pdf_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

This vignette computes all isotopic niche metrics relative to populations and communities.
We first load the packages and the dataset.

```{r setup, warning = F, message = F}
library(SIBER)
library(dplyr)
library(ggplot2)
library(here)
library(magrittr)
library(tidyr)
library(tibble)
library(knitr)
library(siar)
library(reshape2)
library(spatstat.utils)
```


```{r load datasets}

# Full dataset, with C1, crayfish and amphibians
Dataset <- read.csv(file.path(here(), "exported_data", 
                                       "Isotope_data_standardized.csv"), 
                    header=T)

kable(Dataset)
```


Table of the number of samples per pond
```{r number of samples}

table(Dataset$Pond, Dataset$Species)
table(Dataset$Pond, Dataset$Taxa)
```


Calculate the mean sample weight per taxa
```{r sample weights}

Dataset %>%
  group_by(Group) %>%
  summarise(meanweight = round(mean(Weight*1000),0), 
            sdweight = round(sd(Weight*1000),0)) %>% 
  kable()
```



# 1- Regional niche (per species over all ponds)

Select the appropriate species and get the average position of their regional niche.
```{r select appropriate species}

Subset_Dataset <- Dataset %>% dplyr::filter(!Group == "C1")

Subset_Dataset %>% group_by(Species) %>% 
  summarise(meanTP = mean(TP),
            meanD13C = mean(D13Ccor_consoI))

spx <- split(Subset_Dataset$D13Ccor_consoI, Subset_Dataset$Species, 
             drop = TRUE)
spy <- split(Subset_Dataset$TP, Subset_Dataset$Species, drop = TRUE)

```

## a- SEA coordinates
Generate the coordinates of the standard ellipses for each regional niche and export them.
```{r regional SEAc coordinates}

Species <- NULL
coordY <- NULL
coordX <- NULL
j = 1

for (i in 1:length(spx)) {
  SE <- siar::standard.ellipse(spx[[i]], spy[[i]], steps = 1)
  Species[j:(j+360)] <- names(spx)[i]
  coordY[j:(j+360)] <- SE$ySEAc[1:361]
  coordX[j:(j+360)] <- SE$xSEAc[1:361]
  j = j + 361
}

CoordSEAc <- cbind(Species, coordY, coordX)
CoordSEAc <- as.data.frame(CoordSEAc)
CoordSEAc$coordY <- as.numeric(as.character(CoordSEAc$coordY))
CoordSEAc$coordX <- as.numeric(as.character(CoordSEAc$coordX))

write.csv(CoordSEAc, file.path(here(), "exported_data", 
                               "Coordinates_SEAc_regional.csv"), row.names = F)
``` 

## b- Area of ellipses overlap for regional niches
```{r area of ellipses overlap}

#Initialize vectors
Species1 = NULL
Species2 = NULL
AreaOverlap = NULL
AreaSp1 = NULL
AreaSp2 = NULL
Table = data.frame()

# Run command: with crayfish
for (i in names(spx[c(1,3:5)])){
Overlap <- siar::overlap(spx$Crayfish, spy$Crayfish,
                         spx[[i]], spy[[i]], steps=1)
AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
Species1 <- append(Species1, "Crayfish", after = length(Species1))
Species2 <- append(Species2, names(spx[i]), after = length(Species2))
AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
} 
 
# Run command: with agile frog
for (i in names(spx[c(3:5)])){
Overlap <- siar::overlap(spx$`Agile frog`, spy$`Agile frog`,
                         spx[[i]], spy[[i]], steps=1)
AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
Species1 <- append(Species1, "Agile frog", after = length(Species1))
Species2 <- append(Species2, names(spx[i]), after = length(Species2))
AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
} 

# Run command: with marbled newt
for (i in names(spx[c(4:5)])){
Overlap <- siar::overlap(spx$`Marbled newt`, spy$`Marbled newt`,
                         spx[[i]], spy[[i]], steps=1)
AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
Species1 <- append(Species1, "Marbled newt", after = length(Species1))
Species2 <- append(Species2, names(spx[i]), after = length(Species2))
AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
}


# Run command: palmate newt/tree frog (the only one left)
Overlap <- siar::overlap(spx$`Palmate newt`, spy$`Palmate newt`,
                         spx$`Tree frog`, spy$`Tree frog`, steps=1)
AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
Species1 <- append(Species1, "Palmate newt", after = length(Species1))
Species2 <- append(Species2, "Tree frog", after = length(Species2))
AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))

```


Visualize regional overlaps and export them
``` {r analyses of regional overlaps}

Table <- cbind(Species1, Species2, AreaOverlap = round(AreaOverlap,4), 
             AreaSp1 = round(AreaSp1,4), AreaSp2 = round(AreaSp2,4))

Table <- as.data.frame(Table)
Table$Prct_overlap <- round(as.numeric(Table$AreaOverlap) / (as.numeric(Table$AreaSp1)+as.numeric(Table$AreaSp2)),4)
Table$Prct_overlap_sp2 <- round(as.numeric(Table$AreaOverlap) / as.numeric(Table$AreaSp2),4)
Table$Prct_overlap_sp1 <- round(as.numeric(Table$AreaOverlap) / as.numeric(Table$AreaSp1),4)

kable(Table)

write.csv(Table, file.path(here(), "exported_data", 
                           "Overlap_regional_niches.csv"), row.names = F)
```








# 2- Population metrics

We calculate population metrics for amphibians and crayfish.

We begin with selecting the species of interest and removing populations with inadequate samples sizes, i.e. large populations with n < 10. Some populations have n < 10 but are kept because we have good indicators from CMR that the sample size is representative of the population.

```{r select appropriate populations, message = F, warning = F}

Subset_Dataset <- Dataset %>% dplyr::filter(!Group == "C1")

# We want to exclude target populations with n < 10, except three pops: marbled newt in ponds P04 and P11, and palmate newt in pop P10 where we assume we have sampled the entire population.
Subset_Dataset %>% group_by(Species, Pond) %>% summarise(n = n()) %>% 
  filter(n < 10)

Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Crayfish"|
                                 !Subset_Dataset$Pond == "P06",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Agile frog"|
                                 !Subset_Dataset$Pond=="P02",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Agile frog"|
                                 !Subset_Dataset$Pond=="P17",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Marbled newt"|
                                 !Subset_Dataset$Pond=="P08",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Marbled newt"|
                                 !Subset_Dataset$Pond=="P10",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Palmate newt"|
                                 !Subset_Dataset$Pond=="P07",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Palmate newt"|
                                 !Subset_Dataset$Pond== "P13",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Palmate newt"|
                                 !Subset_Dataset$Pond== "P14",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Palmate newt"|
                                 !Subset_Dataset$Pond=="P16",]
Subset_Dataset<-Subset_Dataset[!Subset_Dataset$Species=="Palmate newt"|
                                 !Subset_Dataset$Pond=="P17",]


table(Subset_Dataset$Pond, Subset_Dataset$Species)

# Separate per niche (species x pond)
spx <- split(Subset_Dataset$D13Ccor_consoI, 
             list(Subset_Dataset$Pond, Subset_Dataset$Species), drop = TRUE)
spy <- split(Subset_Dataset$TP, 
             list(Subset_Dataset$Pond, Subset_Dataset$Species), drop = TRUE)
```

Check if the number of populations is correct

```{r check number of individuals is correct}

dim(Subset_Dataset[Subset_Dataset$Taxa=="Agile frog",])[1] == 254 
dim(Subset_Dataset[Subset_Dataset$Taxa=="Tree frog",])[1] == 168
dim(Subset_Dataset[Subset_Dataset$Taxa=="Palmate newt",])[1] == 192
dim(Subset_Dataset[Subset_Dataset$Taxa=="Marbled newt",])[1] == 101
dim(Subset_Dataset[Subset_Dataset$Species=="Crayfish",])[1] == 348

```


## a- Calculation of SEAc

We first calculate SEAc on each population for each pond. This is done by providing a vector containing the list of populations and ponds.

```{r calculate population ellipses}

Subset_Dataset_ellipses <- Subset_Dataset %>% 
  dplyr::select("iso1" = D13Ccor_consoI, "iso2" = TP, "group" = Species, 
                "community" = Pond) %>%
  as.data.frame()

Subset_Dataset_SIBER <- createSiberObject(Subset_Dataset_ellipses)
Pop_metrics_SEAc <- groupMetricsML(Subset_Dataset_SIBER)

#Table transformation
Pop_metrics_ellipses <- as.data.frame(t(Pop_metrics_SEAc))
Pop_metrics_ellipses$Code <- rownames(Pop_metrics_ellipses)
Pop_metrics_ellipses$Pond <- gsub("[.].*","",Pop_metrics_ellipses$Code)
Pop_metrics_ellipses$Species <- gsub(".*.[.]","",Pop_metrics_ellipses$Code)

```


```{r merge datasets}

Pop_metrics <- Pop_metrics_ellipses[-1]

write.csv(Pop_metrics, 
          file.path(here(), "exported_data", "Population_metrics.csv"), 
          row.names = F)
```


## b- SEA coordinates 

```{r population SEAc coordinates, warning = F, message = F}

Pop <- NULL
coordY <- NULL
coordX <- NULL
j = 1

for (i in 1:length(spx)) {
  SE <- standard.ellipse(spx[[i]],spy[[i]],steps=1)
  Pop[j:(j+360)]<-names(spx)[i]
  coordY[j:(j+360)]<-SE$ySEAc[1:361]
  coordX[j:(j+360)]<-SE$xSEAc[1:361]
  j=j+361
}

CoordSEAc <- cbind(Pop,coordY,coordX)
summary(CoordSEAc)
CoordSEAc <- as.data.frame(CoordSEAc)
CoordSEAc$coordY <- as.numeric(as.character(CoordSEAc$coordY))
CoordSEAc$coordX <- as.numeric(as.character(CoordSEAc$coordX))
str(CoordSEAc)
CoordSEAc$Pond <- gsub("\\..*","",CoordSEAc$Pop)
CoordSEAc$Species <- gsub(".*\\.","",CoordSEAc$Pop)
head(CoordSEAc)
CoordSEAc$Pond <- as.factor(CoordSEAc$Pond)
levels(CoordSEAc$Pond)

write.csv(CoordSEAc, 
          file.path(here(), "exported_data", "Coordinates_SEAc_populations.csv"), 
          row.names = F)
``` 


```{r centroides of standard ellipses}

CoordSEAc <- read.csv(file.path(here(), "exported_data",
                                "Coordinates_SEAc_populations.csv"), header=T)

Mean_position <- CoordSEAc %>% group_by(Pond, Species, Pop) %>%
  summarise(TPavg = mean(coordY),
            D13Cavg = mean(coordX))

write.csv(Mean_position, file.path(here(), "exported_data", 
                                   "Meanposition_SEAc.csv"), row.names = F)

```




## c- Area of ellipses overlap

```{r area of ellipses overlap: initialize vectors}

#Split dataset by species
Crayfish <- Subset_Dataset %>% filter(Species == "Crayfish")
Treefrog <- Subset_Dataset[Subset_Dataset$Taxa == "Tree frog",] 
Agilefrog <- Subset_Dataset[Subset_Dataset$Taxa == "Agile frog",] 
Palmatenewt <- Subset_Dataset[Subset_Dataset$Taxa == "Palmate newt",] 
Marblednewt <- Subset_Dataset[Subset_Dataset$Taxa == "Marbled newt",] 


#For each species, split dataset by pond
spx_Agilefrog <- split(Agilefrog$D13Ccor_consoI, list(Agilefrog$Pond), 
                       drop = FALSE)
spy_Agilefrog <- split(Agilefrog$TP, list(Agilefrog$Pond), 
                       drop = FALSE)
spx_Treefrog <- split(Treefrog$D13Ccor_consoI, list(Treefrog$Pond), 
                       drop = FALSE)
spy_Treefrog <- split(Treefrog$TP, list(Treefrog$Pond), 
                       drop = FALSE)
spx_Palmatenewt <- split(Palmatenewt$D13Ccor_consoI, list(Palmatenewt$Pond), 
                       drop = FALSE)
spy_Palmatenewt <- split(Palmatenewt$TP, list(Palmatenewt$Pond), 
                       drop = FALSE)
spx_Marblednewt <- split(Marblednewt$D13Ccor_consoI, list(Marblednewt$Pond), 
                       drop = FALSE)
spy_Marblednewt <- split(Marblednewt$TP, list(Marblednewt$Pond), 
                       drop = FALSE)
spx_Crayfish <- split(Crayfish$D13Ccor_consoI, list(Crayfish$Pond), 
                       drop = FALSE)
spy_Crayfish <- split(Crayfish$TP, list(Crayfish$Pond), 
                       drop = FALSE)

#Initialize vectors
Pond = NULL
Species1 = NULL
Species2 = NULL
AreaOverlap = NULL
AreaSp1 = NULL
AreaSp2 = NULL
Table = data.frame()
```

## All crayfish
```{r loop over all crayfish}

for (i in names(spx_Crayfish)) {
  if (length(spx_Agilefrog[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Crayfish", after = length(Species1))
    Species2 <- append(Species2, "Agile frog", after = length(Species2))
    Overlap <- siar::overlap(spx_Crayfish[[i]], spy_Crayfish[[i]],
                             spx_Agilefrog[[i]], spy_Agilefrog[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Treefrog[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Crayfish", after = length(Species1))
    Species2 <- append(Species2, "Tree frog", after = length(Species2))
    Overlap <- siar::overlap(spx_Crayfish[[i]], spy_Crayfish[[i]],
                             spx_Treefrog[[i]], spy_Treefrog[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Palmatenewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Crayfish", after = length(Species1))
    Species2 <- append(Species2, "Palmate newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Crayfish[[i]], spy_Crayfish[[i]],
                             spx_Palmatenewt[[i]], spy_Palmatenewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Marblednewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Crayfish", after = length(Species1))
    Species2 <- append(Species2, "Marbled newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Crayfish[[i]], spy_Crayfish[[i]],
                             spx_Marblednewt[[i]], spy_Marblednewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}
```

## Between amphibians
```{r area of ellipses overlap: loop between amphibians}

for (i in names(spx_Agilefrog)) {
  if (length(spx_Treefrog[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Agile frog", after = length(Species1))
    Species2 <- append(Species2, "Tree frog", after = length(Species2))
    Overlap <- siar::overlap(spx_Agilefrog[[i]], spy_Agilefrog[[i]],
                             spx_Treefrog[[i]], spy_Treefrog[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Palmatenewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Agile frog", after = length(Species1))
    Species2 <- append(Species2, "Palmate newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Agilefrog[[i]], spy_Agilefrog[[i]],
                             spx_Palmatenewt[[i]], spy_Palmatenewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Marblednewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Agile frog", after = length(Species1))
    Species2 <- append(Species2, "Marbled newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Agilefrog[[i]], spy_Agilefrog[[i]],
                             spx_Marblednewt[[i]], spy_Marblednewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}



for (i in names(spx_Treefrog)) {
  if (length(spx_Palmatenewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Tree frog", after = length(Species1))
    Species2 <- append(Species2, "Palmate newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Treefrog[[i]], spy_Treefrog[[i]],
                             spx_Palmatenewt[[i]], spy_Palmatenewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
  
  if (length(spx_Marblednewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Tree frog", after = length(Species1))
    Species2 <- append(Species2, "Marbled newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Treefrog[[i]], spy_Treefrog[[i]],
                             spx_Marblednewt[[i]], spy_Marblednewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}


for (i in names(spx_Palmatenewt)) {
  if (length(spx_Marblednewt[[i]]) != 0) {
    Pond <- append(Pond, i, after = length(Pond))
    Species1 <- append(Species1, "Palmate newt", after = length(Species1))
    Species2 <- append(Species2, "Marbled newt", after = length(Species2))
    Overlap <- siar::overlap(spx_Palmatenewt[[i]], spy_Palmatenewt[[i]],
                             spx_Marblednewt[[i]], spy_Marblednewt[[i]], steps=1)
    AreaOverlap <- append(AreaOverlap, Overlap$overlap, after = length(AreaOverlap))
    AreaSp1 <- append(AreaSp1, Overlap$area1, after = length(AreaSp1))
    AreaSp2 <- append(AreaSp2, Overlap$area2, after = length(AreaSp2))
  }
}

```


## Analyses of overlap areas

``` {r analyses of population overlaps}

Table <- cbind(Pond, Species1, Species2, AreaOverlap = round(AreaOverlap,4), 
             AreaSp1 = round(AreaSp1,4), AreaSp2 = round(AreaSp2,4))

Table <- as.data.frame(Table)
Table$Prct_overlap <- round(as.numeric(Table$AreaOverlap) / (as.numeric(Table$AreaSp1)+as.numeric(Table$AreaSp2)),4)
Table$Prct_overlap_sp2 <- round(as.numeric(Table$AreaOverlap) / as.numeric(Table$AreaSp2),4)
Table$Prct_overlap_sp1 <- round(as.numeric(Table$AreaOverlap) / as.numeric(Table$AreaSp1),4)

head(Table)

write.csv(Table, file.path(here(), "exported_data", "Overlap_populations.csv"), 
          row.names = F)

```


```{r generate the long version of this table for Supp Mat}

Pop_metrics <- read.csv(file.path(here(), "exported_data", 
                                  "Population_metrics.csv"))

Mean_position <- read.csv(file.path(here(), "exported_data", 
                                    "Meanposition_SEAc.csv"))

names(Mean_position)[3] = "Code"
Mean_position %<>% dplyr::select(-Pond, -Species) 
Pop_metrics <- merge(Pop_metrics, Mean_position, by = "Code")
Pop_metrics %<>% dplyr::select(Pond, Species, SEAc, TPavg, D13Cavg)

Pop_metrics_long <- rbind(
      Pop_metrics %>% dcast(Pond ~ Species, value.var = "SEAc") %>% add_column(Metrics = "SEAc"),
      Pop_metrics %>% dcast(Pond ~ Species, value.var = "TPavg") %>% add_column(Metrics = "TPavg"),
      Pop_metrics %>% dcast(Pond ~ Species, value.var = "D13Cavg") %>% add_column(Metrics = "D13Cavg"))
      

write.csv(Pop_metrics_long, file.path(here(), "exported_data", "Population_metrics_long.csv"), row.names = F)
```


