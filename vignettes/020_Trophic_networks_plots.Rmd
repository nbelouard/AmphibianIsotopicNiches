---
title: "#2: Network plots"
author: 
- Nadege Belouard^[UMR CNRS EcoBio, UMR INRAE DECOD, nadege.belouard@gmail.com]
date: "23/09/2022"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---

This vignette draws all the plots related to the trophic networks. First, we load the different packages and datasets that we need and create a 'figure' folder.

```{r setup, message = F, warning = F}
library(ggplot2)
library(ggrepel)
library(dplyr)
library(here)

Dataset <- read.csv(file.path(here(), "exported_data", 
                              "Isotope_data_standardized.csv"), header=T)

if (file.exists(file.path(here(), "figures")) == FALSE){
  dir.create(file.path(here(), "figures"))
}
```

We summarize each taxa by the average point and its SD to graphically represent the position and the variability in the isotopic signature of each taxa.

```{r averaged points, warning = F, message = F}

Avg_data_raw <- Dataset %>% group_by(Taxa, Pond) %>%
  summarise(D15Navg = mean(D15N),
            D13Cavg = mean(D13C),
            D15Nsd = sd(D15N),
            D13Csd = sd(D13C))
```


# 0- Visualize raw datasets
We first visualize raw networks without any correction or standardization.
```{r visualize raw networks}

if (file.exists(file.path(here(), "figures", "0.raw")) == FALSE){
  dir.create(file.path(here(), "figures", "0.raw"))
}

for (i in levels(as.factor(Dataset$Pond))) {
  M_ind <- Dataset %>% filter(Pond == i) %>%
    filter(Group %in% c("Crayfish", "Amphibians"))
  M_ind_C1 <- Dataset %>% filter(Pond == i) %>%
    filter(!Group %in% c("Crayfish", "Amphibians"))
  M_avg <- Avg_data_raw %>% filter(Pond == i) %>%
  filter (!Taxa %in% c("Ad crayfish", "Juv crayfish", "Agile frog", "Tree frog", 
                       "Palmate newt", "Marbled newt"))
  
f <- ggplot(data = M_avg, aes(x = D13Cavg, y = D15Navg), show.legend = F) + 
  theme_classic() +
  ggtitle(i) +
  geom_text_repel(data = M_avg,
                  aes(x = D13Cavg, y = D15Navg, label = Taxa),
                      colour = "darkgray", size = 3, show.legend = F) +
  geom_errorbar(data = M_avg,
                aes(y = D15Navg, ymin = D15Navg - D15Nsd, ymax = D15Navg + D15Nsd),
                colour = "darkgrey", width = 0.05, show.legend = F) +
  geom_errorbar(data = M_avg,
                 aes(x = D13Cavg, xmin = D13Cavg - D13Csd,
                     xmax = D13Cavg + D13Csd),
                 colour = "darkgrey", width = 0.05, show.legend = F) +
    geom_point(data = M_ind, aes(x = D13C, y = D15N), colour = "darkgrey",
             size = 1, show.legend = F)+
   geom_point(data = M_ind_C1, aes(x = D13C, y = D15N, colour = Taxa),
             size = 1, show.legend = F)+
  xlab(expression(paste('D'^{13},'C'))) + 
  ylab(expression(paste('D'^{15},'N')))

ggsave(f, filename = file.path(here(), "figures", "0.raw", 
                               paste("P",i,"_raw.png",sep="")), 
       width=4, height=4)

}



# facet wrap version
Data_interest <- Dataset %>%
    filter(Group %in% c("Crayfish", "Amphibians"))
Data_C1 <- Dataset %>% 
  filter(!Group %in% c("Crayfish", "Amphibians")) %>% 
  filter(!Taxa %in% c("Zooplankton", "Gammarus", "Asellus"))
  
f <- ggplot(data = Avg_data_raw, aes(x = D13Cavg, y = D15Navg), show.legend = F) + 
  # theme_classic() +
  geom_errorbar(data = Avg_data_raw %>%
  filter (!Taxa %in% c("Ad crayfish", "Juv crayfish", "Agile frog", "Tree frog", 
                       "Palmate newt", "Marbled newt")),
                aes(y = D15Navg, ymin = D15Navg - D15Nsd, ymax = D15Navg + D15Nsd,
                colour = Taxa), width = 0.05, show.legend = F) +
  geom_errorbar(data = Avg_data_raw %>%
  filter (!Taxa %in% c("Ad crayfish", "Juv crayfish", "Agile frog", "Tree frog", 
                       "Palmate newt", "Marbled newt")),
                 aes(x = D13Cavg, xmin = D13Cavg - D13Csd,
                     xmax = D13Cavg + D13Csd,
                 colour = Taxa), width = 0.05, show.legend = F) +
   geom_point(data = Data_C1, aes(x = D13C, y = D15N, colour = Taxa),
             size = 1)+
  facet_wrap(~Pond) +
  xlab(expression(paste('D'^{13},'C'))) + 
  ylab(expression(paste('D'^{15},'N')))

f

ggsave(f, filename = file.path(here(), "figures", "0.raw", 
                               "global.png", sep=""), 
       width=10, height=10)
```


# 1- Effect of data correction
First, the effect of the lipid correction. These plots show raw points and points corrected for lipids.

```{r visualize lipid correction}

if (file.exists(file.path(here(),"figures", "1.lipid_correction")) == FALSE){
  dir.create(file.path(here(),"figures", "1.lipid_correction"))
}

for (i in levels(as.factor(Dataset$Pond))) {
  M_ind <- Dataset %>% filter(Pond == i)
  M_avg <- Avg_data_raw %>% filter(Pond == i)

f <- ggplot(data = M_ind, aes(x = D13C, y = D15N), show.legend = F) + 
  theme_classic() +
  ggtitle(i) +
  geom_point(data = M_ind, aes(x = D13C, y = D15N, colour = Taxa), 
             show.legend = F)+ 
  geom_point(data = M_ind, aes(x = D13C_LF, y = D15N, colour = Taxa), 
             pch = 4, show.legend = F)+
  geom_text_repel(data = M_avg, aes(x = D13Cavg, y = D15Navg, label = Taxa, 
                                    colour = Taxa), 
                  size = 3, hjust = 0, vjust = 1, show.legend = F) +
  xlab(expression(paste('D'^{13},'C (points) and D'^{13},
                        'C corrected for lipids (cross)' ))) + 
  ylab(expression(paste('D'^{15},'N')))

ggsave(f, filename = file.path(here(), "figures", "1.lipid_correction", paste("P",i,"_lipidcorrected.png",sep="")), width=6, height=6)

}


```


Second, the effect of the fin correction. These plots show lipid-corrected points and points corrected for the use of fin instead of muscle.

```{r visualize fin correction}

if (file.exists(file.path(here(),"figures", "2.fin_correction")) == FALSE){
  dir.create(file.path(here(),"figures", "2.fin_correction"))
}

for (i in levels(as.factor(Dataset$Pond))) {
  M_ind <- Dataset %>% filter(Pond == i)
  M_avg <- Avg_data_raw %>% filter(Pond == i)

f <- ggplot(M_ind, aes(x = D13C_LF, y = D15N), show.legend = F) + 
  theme_classic() +
  ggtitle(i) +
  geom_point(data = M_ind, aes(x = D13C_LF, y = D15N, colour = Taxa), 
             show.legend = F) +
  geom_point(data = M_ind, aes(x = D13C_LFMu, y = D15N_Mu, colour = Taxa), 
             pch = 2, show.legend = F) +
  geom_text_repel(data = M_avg, aes(x = D13Cavg, y = D15Navg, label = Taxa, 
                                    colour = Taxa), 
                  size = 3, hjust = 0.5, vjust = 1, show.legend = F) +
  xlab(expression(paste('D'^{13},'C corrected for lipids (points) and D'^{13},
                        'C corrected for lipids and fins (triangles)' ))) + 
  ylab(expression(paste('D'^{15},'N (points) and D'^{15},
                        'N corrected for fins (triangles)')))

ggsave(f, filename = file.path(here(), "figures", "2.fin_correction", paste("P",i,"_fincorrected.png",sep="")), width=6, height=6)

}

```


# 2- Plot the corrected data for each pond

These plots show corrected points only.

```{r plot raw networks, warning = F, message = F}

if (file.exists(file.path(here(),"figures", "3.corrected")) == FALSE){
  dir.create(file.path(here(),"figures", "3.corrected"))
}


for (i in levels(as.factor(Dataset$Pond))) {
  M_ind <- Dataset %>% filter(Pond == i) %>%
    filter(Group %in% c("Crayfish", "Amphibians"))
  M_avg <- Avg_data_raw %>% filter(Pond == i) %>%
  filter (!Taxa %in% c("Ad crayfish", "Juv crayfish", "Agile frog", "Tree frog", 
                       "Palmate newt", "Marbled newt"))

f <- ggplot(data = M_avg, aes(x = D13Cavg, y = D15Navg)) +
  theme_classic() +
  ggtitle(i) +
  geom_text_repel(data = M_avg, 
                  aes(x = D13Cavg, y = D15Navg, label = Taxa),
                  colour = "darkgrey", size = 3, show.legend = F) + 
  geom_errorbar(data = M_avg, 
                aes(y = D15Navg, ymin = D15Navg - D15Nsd, 
                    ymax = D15Navg + D15Nsd), 
                colour = "darkgrey", width = 0.05, show.legend = F) +
  geom_errorbarh(data = M_avg, 
                 aes(x = D13Cavg, xmin = D13Cavg - D13Csd, 
                     xmax = D13Cavg + D13Csd), 
                 colour = "darkgrey", height = 0.05, show.legend = F) +
  geom_point(data = M_ind, aes(x = D13C_LFMu, y = D15N_Mu, colour = Taxa), 
             size = 1, show.legend=F) +
  xlab(expression(paste('D'^{13},'C corrected for lipids and fins' ))) + 
  ylab(expression(paste('D'^{15},'N corrected for fins')))

ggsave(f, filename = file.path(here(), "figures", "3.corrected", paste("P",i,"_corrected.png",sep="")), width=6, height=6)

}

```


# 3- Effect of data standardization

Effect of N correction. These plots show corrected points and points corrected for N.

```{r visualize N correction, message = F, warning = F}

Avg_data_stdN <- Dataset %>% group_by(Taxa, Pond) %>%
  summarise(TPavg = mean(TP),
            D13Cavg = mean(D13C_LFMu),
            TPsd = sd(TP),
            D13Csd = sd(D13C_LFMu))

if (file.exists(file.path(here(),"figures", "4.N_correction")) == FALSE){
  dir.create(file.path(here(),"figures", "4.N_correction"))
}

for (i in levels(as.factor(Dataset$Pond))) {
  M_ind <- Dataset %>% filter(Pond == i)
  M_avg <- Avg_data_stdN %>% filter(Pond == i)

f <- ggplot(M_ind, aes(x = D13C_LFMu, y = D15N_Mu), show.legend = F) + 
  theme_classic() +
  ggtitle(i) +
  geom_point(data = M_ind, aes(x = D13C_LFMu, y = D15N_Mu, colour = Taxa), 
             show.legend = F) +
  geom_point(data = M_ind, aes(x = D13C_LFMu, y = TP, colour = Taxa), pch = 2, 
             show.legend = F) +
  geom_text_repel(data = M_avg, aes(x = D13Cavg, y = TPavg, label = Taxa, 
                                    colour = Taxa), 
                  size = 3, hjust = 0.5, vjust = 1, show.legend = F) +
    xlab(expression(paste('D'^{13},'C corrected for lipids' ))) + 
  ylab(expression(paste('D'^{15},'N corrected for fins (points) and 
                        TP (triangles)')))

ggsave(f, filename = file.path(here(), "figures", "4.N_correction", paste("P",i,"_Ncorrected.png",sep="")), width=6, height=6)

}

```


Effect of C correction. These plots show corrected points and points corrected for C.

```{r visualize C correction, message = F, warning = F}

Avg_data_std <- Dataset %>% group_by(Taxa, Pond) %>%
  summarise(TPavg = mean(TP),
            D13Cavg = mean(D13Ccor_consoI),
            TPsd = sd(TP),
            D13Csd = sd(D13Ccor_consoI))

if (file.exists(file.path(here(),"figures", "5.C_correction")) == FALSE){
  dir.create(file.path(here(),"figures", "5.C_correction"))
}

for (i in levels(as.factor(Dataset$Pond))) {
  M_ind <- Dataset %>% filter(Pond == i)
  M_avg <- Avg_data_std %>% filter(Pond == i)

f <- ggplot(M_ind, aes(x = D13C_LFMu, y = TP), show.legend = F) + 
  theme_classic() +
  ggtitle(i) +
  geom_point(data = M_ind, aes(x = D13C_LFMu, y = TP, colour = Taxa), 
             show.legend = F) +
  geom_point(data = M_ind, aes(x = D13Ccor_consoI, y = TP, colour = Taxa), 
             pch = 2, show.legend = F) +
    xlab(expression(paste('D'^{13},'C corrected for lipids and fins (points) 
                          and D'^{13},'C standardized (triangles)' ))) + 
  ylab("TP (triangles)")

ggsave(f, filename = file.path(here(), "figures", "5.C_correction", paste("P",i,"_Ccorrected.png",sep="")), width=6, height=6)

}

```


# 4- Plot standardized data

These plots show standardized trophic networks (TP and D13Ccor) with the species of interest, not the C1 baseline taxa

```{r plot standardized networks consoI, message = F, warning = F}

Avg_data_std <- Dataset %>% group_by(Taxa, Pond) %>%
  summarise(TPavg = mean(TP),
            D13Cavg = mean(D13Ccor_consoI),
            TPsd = sd(TP),
            D13Csd = sd(D13Ccor_consoI))

if (file.exists(file.path(here(),"figures", "6.standardized_networks")) == FALSE){
  dir.create(file.path(here(),"figures", "6.standardized_networks"))
}

for (i in levels(as.factor(Dataset$Pond))) {
    M_ind <- Dataset %>% filter(Pond == i) %>%
    filter(Group %in% c("Crayfish", "Amphibians"))
  M_avg <- Avg_data_std %>% filter(Pond == i) %>%
  filter (!Taxa %in% c("Ad crayfish", "Juv crayfish", "Agile frog", "Tree frog", 
                       "Palmate newt", "Marbled newt"))

f <- ggplot(data = M_avg, aes(x = D13Cavg, y = TPavg)) +
  theme_classic() +
  ggtitle(i) +
  geom_text_repel(data = M_avg, 
                  aes(x = D13Cavg, y = TPavg, label = Taxa),
                  colour = "darkgrey", size = 3, show.legend = F) + 
  geom_errorbar(data = M_avg, 
                aes(y = TPavg, ymin = TPavg - TPsd, ymax = TPavg + TPsd), 
                colour = "darkgrey", width = 0.05, show.legend = F) +
  geom_errorbarh(data = M_avg, 
                 aes(x = D13Cavg, xmin = D13Cavg - D13Csd, 
                     xmax = D13Cavg + D13Csd), 
                 colour = "darkgrey", height = 0.05, show.legend = F) +
  geom_point(data = M_ind, aes(x = D13Ccor_consoI, y = TP, colour = Taxa), 
             size = 1, show.legend=F) +
  xlim(c(min(Dataset$D13Ccor_consoI), max(Dataset$D13Ccor_consoI))) +
  ylim(c(min(Dataset$TP), max(Dataset$TP))) +
  xlab(expression(paste('D'^{13},'C corrected and standardized' ))) + 
  ylab("TP")

ggsave(f, filename = file.path(here(), "figures", "6.standardized_networks", paste("P",i,"_std.png",sep="")), width=6, height=6)
}
```


All the figures produced by this vignette can be found in the subfolder "figures".